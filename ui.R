# crisprepo-shiny

# Copyright (c) 2018 Tobias Neumann, Jesse Lipp, Florian Andersch.
# 
# crisprepo-shiny is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
# 
# crisprepo-shiny is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
# 
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.


header <- dashboardHeader(
  title = "CRISPRepo"
)

sidebar <- dashboardSidebar(
  width = 250,
  useShinyjs(),
  sidebarMenu(id="tabs", 
              tags$head(tags$style(".inactiveLink { 
                                      visibility: hidden;
                                      }")),
              menuItem(text = "Genome-wide Screens", 
                       tabName = "gwsSidebar", startExpanded=TRUE,
                       menuSubItem(text = "Browse Screen", tabName = "gwsBrowseScreenTab", selected = TRUE), 
                       menuSubItem(text = "Gene Search", tabName = "gwsGeneTab"),
                       menuSubItem(text = "Libraries", tabName = "libSidebar"),
                       menuItemOutput("essentialomeSidebar"),
                       menuItemOutput("sgRNAInfoSidebar")),
              menuItem(text = "Expression data", 
                       tabName = "expressionSidebar", startExpanded=TRUE,
                       menuItemOutput("expressionDataSidebar"), 
                       menuItemOutput("slamseqDataSidebar")),
              menuItem(text = "Genome-wide sgRNA predictions", 
                       tabName = "gwsSgRNASidebar", startExpanded=TRUE,
                       menuItemOutput("sgRNAsSidebar"),
                       menuItemOutput("dualSgRNAsTopCombinationsSidebar"),
                       menuItemOutput("dualSgRNAsPredictCombinationsSidebar")),
              menuItem(text = "Other tools",
                       tabName = "tools", startExpanded = TRUE,
                       menuItemOutput("patientMutationSidebar"),
                       menuItemOutput("cellLineSidebar"),
                       menuItemOutput("cellLineSelectorSidebar"),
                       menuItemOutput("geneOfInterestSidebar"),
                       menuItemOutput("groupTestingSidebar"),
                       menuItemOutput("correlationsSidebar"))
  )
)

body <- dashboardBody(
  mainPanel(tags$head(tags$script(jscode))),
  

  tabItems(
    
    # Genome-wide Screens
  
    #Browse Screen
    tabItem(tabName = "gwsBrowseScreenTab", width = NULL,
            fluidRow(tags$head(tags$style(HTML('#gwsBrowseScreenInfo{
                                                 color:tomato; 
                                                 font-weight: 
                                                 bold;
                                                }
                                                [data-title] {
                                                  position: relative;
                                                }
                                                [data-title]:after {
                                                  content: attr(data-title);
                                                  background-color: #fed8b1;
                                                  color: black;
                                                  font-size: 100%;
                                                  padding: 1px 5px 2px 5px;
                                                  bottom: -2.5em;
                                                  border: 4px solid rgb(255, 255, 255);
                                                  border-radius: 5px;
                                                  left: -100%;
                                                  position: absolute;
                                                  z-index: 99999;
                                                  visibility: hidden;
                                                  width: min-content;
                                                }
                                                [data-title]:hover:after {
                                                  opacity: 1;
                                                  transition: all 0.1s ease 0.5s;
                                                  visibility: visible;
                                                }'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, textOutput(outputId="gwsBrowseScreenInfo")))),
            fluidRow(
              useShinyjs(),
              column(width = 9,
                     box(title = "Screens", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="gwsBrowseScreenTable"))),
                     box(title = "Contrasts", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="gwsBrowseScreenContrastTable"))),
                     box(title = "Samples", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="gwsBrowseScreenSampleTable")))),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         radioButtons(
                           "gwsBrowseScreenSearchRadio",
                           label = "Search:",
                           choices = list("Genes" = "gene_id", "Guides" = "guide_id"),
                           selected = "gene_id",
                           inline = T
                         ),

                         radioButtons(
                           "gwsBrowseScreenSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human", "Mouse" = "mouse", "All"="all"),
                           selected = "human",
                           inline = T
                         ),
                         
                         bsTooltip("gwsBrowseScreenIndexRadio", HTML("Effect: scaled LFCs between -1 (essential) and 0 (nonessential) <br/><br/> FDR-adjusted effect: scaled LFCs gets adjusted (weakened) for false positive (high FDR) genes. Scaled LFCs incoorpoprate its gene-level FDR and good-guides ratio (calculated by mageck) to reduce amount of false positives."), placement = "left", trigger = "hover"),

                         radioButtons(
                           "gwsBrowseScreenIndexRadio",
                           label = "Display data as:",
                           choices = list("Log-fold change" = "lfc", "Effect" = "effect_essentialome", "FDR-adjusted effect" = "adjusted_effect_essentialome"),
                           selected = "adjusted_effect_essentialome",
                           inline = F
                         ),
                         
                         radioButtons(
                           "gwsBrowseScreenDisplayName",
                           label = "Display screen IDs as:",
                           choices = list("Short quality-control ID" = "short", "Unique ID" = "long"),
                           selected = "short",
                           inline = T
                         ),
                         
                         checkboxGroupInput(
                           "gwsBrowseScreenInclude",
                           label = "Include gene-level statistics:",
                           choices = list("P-value" = "p", "FDR" = "fdr", "Guides-good" = "guides_good", "Guides-total" = "guides"),
                           selected = NULL,
                           inline = F
                         ),
                         
                         sliderInput("gwsBrowseScreenQuality", "Minimal dynamic range of screens (quality filtering):",
                                     min = 0, 
                                     max = 8, 
                                     value = 1.5,
                                     step = 0.1
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         selectizeInput(
                           inputId = "gwsBrowseScreenDatasetSelect",
                           label = "Dataset:",
                           choices = dataset_selection_all,
                           multiple = TRUE,
                           selected = "dropout"
                         ),
                         selectizeInput(
                           inputId = "gwsBrowseScreenTissueSelect",
                           label = "Tissue:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "gwsBrowseScreenCheckTissueAll",
                           label = "Browse all tissues",
                           value = FALSE
                         ),
                         selectizeInput(
                           inputId = "gwsBrowseScreenCellLineSelect",
                           label = "Cell line:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "gwsBrowseScreenCheckCellLineAll",
                           label = "Browse all cell lines",
                           value = FALSE
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "gwsBrowseScreenLibrarySelect",
                             label = "Library:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           checkboxInput(
                             inputId = "gwsBrowseScreenCheckLibraryAll",
                             label = "Browse all libraries",
                             value = FALSE
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "gwsBrowseScreenContrastSelect",
                             label = "Screen:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           checkboxInput(
                             inputId = "gwsBrowseScreenCheckContrastAll",
                             label = "Browse all Contrasts",
                             value = FALSE
                           )
                         ),
                         disabled(
                           actionButton(inputId = "gwsBrowseScreenLoadButton", 
                                        label = "Load data!"
                           )
                         )
                     ),

                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "gwsBrowseScreenButtonDownload",
                         label = "Download displayed table"
                       )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       checkboxGroupInput(
                         "gwsBrowseScreenDownloadPrimaryTablesCheck",
                         label = "Download HQ dropout screen data (scaled LFCs table):",
                         choices = list("Human" = "Human", "Mouse" = "Mouse"),
                         selected = c("Human", "Mouse"),
                         inline = F
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "gwsBrowseScreenButtonDownloadPrimaryTables",
                         label = "Download essentiality data"
                       )),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       checkboxGroupInput(
                         "gwsBrowseScreenDownloadAdjustedPrimaryTablesCheck",
                         label = "Download fdr-adjusted HQ dropout screen data (fdr-adjusted scaled LFCs table):",
                         choices = list("Human" = "Human", "Mouse" = "Mouse"),
                         selected = c("Human", "Mouse"),
                         inline = F
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "gwsBrowseScreenButtonDownloadAdjustedPrimaryTables",
                         label = "Download fdr-adjusted essentiality data"
                       ))
                     
              )
            )),
    
    
    #Gene Search
    tabItem(tabName = "gwsGeneTab", width = NULL,
            fluidRow(tags$head(tags$style(HTML('#gwsGeneInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput(outputId="gwsGeneInfo")))),
            fluidRow(
              column(width = 9,
                     box(title = "Screens", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput("gwsGeneTable"))),
                     box(title = "Contrasts", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="gwsGeneContrastTable"))),
                     box(title = "Samples", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="gwsGeneSampleTable")))),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         
                         radioButtons(
                           "gwsGeneSearchRadio",
                           label = "Search:",
                           choices = list("Genes" = "gene_id", "Guides" = "guide_id"),
                           selected = "gene_id",
                           inline = T
                         ),
                         
                         radioButtons(
                           "gwsGeneSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human", "Mouse" = "mouse", "All"="all"),
                           selected = "human",
                           inline = T
                         ),
                         
                         radioButtons(
                           "gwsGeneIndexRadio",
                           label = "Display data as:",
                           choices = list("Log-fold change" = "lfc", "Effect" = "effect_essentialome", "FDR-adjusted effect" = "adjusted_effect_essentialome"),
                           selected = "adjusted_effect_essentialome",
                           inline = F
                         ),
                         
                         radioButtons(
                           "gwsGeneDisplayName",
                           label = "Display screen IDs as:",
                           choices = list("Short quality-control ID" = "short", "Unique ID" = "long"),
                           selected = "short",
                           inline = T
                         ),
                         
                         checkboxGroupInput(
                           "gwsGeneInclude",
                           label = "Include gene-level statistics:",
                           choices = list("P-value" = "p", "FDR" = "fdr", "Guides-good" = "guides_good", "Guides-total" = "guides"),
                           selected = NULL,
                           inline = F
                         ),
                         sliderInput("gwsGeneQuality", "Minimal dynamic range of screens (quality filtering):",
                                     min = 0, 
                                     max = 8, 
                                     value = 1.5,
                                     step = 0.1
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         selectizeInput(
                           inputId = "gwsGeneDatasetSelect",
                           label = "Dataset:",
                           choices = dataset_selection_all,
                           multiple = TRUE,
                           selected = "dropout"
                         ),
                         selectizeInput(
                           inputId = "gwsGeneTissueSelect",
                           label = "Tissue:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "gwsGeneCheckTissueAll",
                           label = "Search All Tissues",
                           value = FALSE
                         ),
                         selectizeInput(
                           inputId = "gwsGeneCellLineSelect",
                           label = "Cell line:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "gwsGeneCheckCellLineAll",
                           label = "Browse all cell lines",
                           value = FALSE
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "gwsGeneLibrarySelect",
                             label = "Library:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           checkboxInput(
                             inputId = "gwsGeneCheckLibraryAll",
                             label = "Search All Libraries",
                             value = FALSE
                             
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "gwsGeneContrastSelect",
                             label = "Contrast:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           checkboxInput(
                             inputId = "gwsGeneCheckContrastAll",
                             label = "Search All Contrasts",
                             value = FALSE
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "gwsGeneGeneSelect",
                             label = "Gene:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           fileInput(
                             "gwsGeneGeneInputFile", "Upload list of genes:",
                             accept = c("text/csv","text/comma-separated-values,text/plain")
                           )
                         ),
                         disabled(
                           actionButton(inputId = "gwsGeneLoadButton", 
                                        label = "Load data!"
                           )
                         )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "gwsGeneButtonDownload",
                         label = "Download displayed table"
                       )
                     )
              )
            )), 
    
     
    # sgRNA info
    tabItem(tabName = "sgRNAInfoSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#sgRNAInfoInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, textOutput(outputId="sgRNAInfoInfo")))),
            fluidRow(
              column(width = 9, 
                     h4("SgRNA values in all used screens:"),
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("sgRNAInfoTableOutputScreens"))),
                     h4("SgRNA prediction scores:"),
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("sgRNAInfoTableOutputPredictions"))),
                     h4("SgRNA validation scores:"),
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("sgRNAInfoTableOutputValidations")))
              ), 
              column(width = 3, 
                     box(width = NULL, solidHeader = TRUE, 
                         radioButtons(
                           "sgRNAInfoSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human", "Mouse" = "mouse", "All"="all"),
                           selected = "human",
                           inline = T
                         ),
                         radioButtons(
                           "sgRNAInfoIndexRadio",
                           label = "Display:",
                           choices = list("Log-fold change" = "lfc", "Effect" = "effect_essentialome"),
                           selected = "lfc",
                           inline = T
                         ),
                         selectInput(inputId = "sgRNAInfoSelectGene",
                                     label = "Gene:",
                                     choices = NULL,
                                     multiple = TRUE,
                                     selected = NULL
                                     ),
                         selectInput(inputId = "sgRNAInfoSelectGuide",
                                     label = "Guide:",
                                     choices = NULL,
                                     multiple = TRUE,
                                     selected = NULL),
                         checkboxInput(
                           inputId = "sgRNAInfoCheckGuideAll",
                           label = "Select all guides",
                           value = FALSE
                         ),
                         disabled(
                           actionButton(inputId = "sgRNAInfoLoadButton", 
                                        label = "Load data!"
                           )
                         )),
                     box(width = NULL, solidHeader = TRUE,
                         downloadButton(width = NULL, 
                                        outputId = "sgRNAInfoButtonDownload",
                                        label = "Download displayed tables"
                        )
                     )
              )
            )
    ),
    
    # Library
    tabItem(tabName = "libSidebar", width = NULL, 
            fluidRow(
              column(width = 9, 
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("libTableOutput")))
              ), 
              column(width = 3, 
                     box(width = NULL, solidHeader = TRUE, 
                         radioButtons(
                           "libSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human", "Mouse" = "mouse", "All"="all"),
                           selected = "human",
                           inline = T
                         ),
                         selectInput(inputId = "libSelectLibrary",
                                     label = "Library:",
                                     choices = NULL,
                                     selectize = TRUE)), 
                     infoBoxOutput(width = NULL, "libBoxGuidesTotal"),
                     infoBoxOutput(width = NULL, "libBoxGenesTotal"),
                     downloadButton(width = NULL, 
                                    outputId = "libButtonDownload",
                                    label = "Download displayed table")
              )
            )
    ),
    
    # sgRNAs
    tabItem(tabName = "sgRNAsSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#sgRNAsInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput(outputId="sgRNAsInfo")))),
            fluidRow(
              column(width = 9, 
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("sgRNAsTableOutput")))
              ), 
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         
                         radioButtons(
                           "sgRNAsSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human", "Mouse" = "mouse", "All"="all"),
                           selected = "",
                           inline = T
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         
                           selectizeInput(
                             inputId = "sgRNAsGeneSelect",
                             label = "Gene:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           ), 
                           fileInput(
                             "sgRNAsGeneInputFile", "Upload list of genes:",
                             accept = c("text/csv","text/comma-separated-values,text/plain")
                           ),
                          disabled(
                             actionButton(inputId = "sgRNAsLoadButton", 
                                          label = "Load data!"
                             )
                           )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "sgRNAsButtonDownload",
                         label = "Download displayed table"
                       )
                     )
              )
            )),
    
    # dual sgRNAs predictions
    tabItem(tabName = "dualSgRNAsPredictCombinationsSidebar", width = NULL,
            fluidRow(tags$head(tags$style(HTML('#dualSgRNAsInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput(outputId="dualSgRNAsInfo")))),
            fluidRow(
              column(width = 9,
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("dualSgRNAsTableOutput")))
              ),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         checkboxInput(
                           inputId = "dualSgRNAs_LimitOutput",
                           label = "Limit the number of reported dual-sgRNA-combinations per gene (check to activate)",
                           value = FALSE
                         ),
                         disabled(
                          sliderInput("dualSgRNAs_nOutput", "Integer:",
                                     min = 0, max = 50,
                                     value = 25)
                         ),
                         fileInput("dualSgRNAs_inputFile", "Choose CSV File",
                                   accept = c(
                                     "text/csv",
                                     "text/comma-separated-values,text/plain",
                                     ".csv")
                         ),
                         actionButton(inputId = "dualSgRNALoadButton", 
                                      label = "Load data!"
                         )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "dualSgRNAsButtonDownload",
                         label = "Download displayed table"
                       )
                     )
              )
            )),
    
    # dual sgRNAs top predicted Combinations
    tabItem(tabName = "dualSgRNAsTopCombinationsSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#dualSgRNAsTopCombinationsInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput(outputId="dualSgRNAsTopCombinationsInfo")))),
            fluidRow(
              column(width = 9, 
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("dualSgRNAsTopCombinationsTableOutput")))
              ), 
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         
                         radioButtons(
                           "dualSgRNAsTopCombinationsSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human", "Mouse" = "mouse", "All"="all"),
                           selected = "",
                           inline = T
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         sliderInput("dualSgRNAsTopCombinationsnOutput", "Limit the number of reported dual-sgRNA-combinations per gene to:",
                                     min = 0, max = 25,
                                     value = 5
                                     ),
                         selectizeInput(
                           inputId = "dualSgRNAsTopCombinationsGeneSelect",
                           label = "Gene:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                           ), 
                         fileInput(
                           "dualSgRNAsTopCombinationsGeneInputFile", "Upload list of genes:",
                           accept = c("text/csv","text/comma-separated-values,text/plain")
                         ),
                         disabled(
                           actionButton(inputId = "dualSgRNAsTopCombinationsLoadButton", 
                                        label = "Load data!"
                           )
                         )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "dualSgRNAsTopCombinationsButtonDownload",
                         label = "Download displayed table"
                       )
                     )
              )
            )),
    
    # Expression Data
    tabItem(tabName = "expressionDataSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#expressionDataInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput((outputId="expressionDataInfo"))))),
            fluidRow(
              column(width = 9,
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("expressionDataTable")))),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         
                         radioButtons(
                           "expressionDataSpeciesSelect",
                           label = "Species:",
                           choices = list(""),
                           selected = "",
                           inline = T
                         ),
                         radioButtons(
                           "expressionDataUnitSelect",
                           label = "Expression metric:",
                           choices = list(""),
                           selected = "",
                           inline = F
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         selectizeInput(
                           inputId = "expressionDataTissueSelect",
                           label = "Tissue:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "expressionDataCheckTissueAll",
                           label = "Search All Tissues",
                           value = FALSE
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "expressionDataCellLineSelect",
                             label = "Cell Line:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           checkboxInput(
                             inputId = "expressionDataCheckCellLineAll",
                             label = "Search All Cell Lines",
                             value = FALSE
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "expressionDataGeneSelect",
                             label = "Gene:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(fileInput("expressionData_inputFile", "Upload list of genes:",
                                   accept = c(
                                     "text/csv",
                                     "text/comma-separated-values,text/plain")
                         )),
                         disabled(
                           checkboxInput(
                             inputId = "expressionDataCheckGeneAll",
                             label = "Search All Genes",
                             value = FALSE
                           )
                         ),
                         disabled(
                           actionButton(inputId = "expressionDataLoadButton", 
                                        label = "Load data!"
                           )
                         )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "expressionDataButtonDownload",
                         label = "Download displayed table"
                       )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       checkboxGroupInput(
                         "expressionDataDownloadPrimaryTablesCheck",
                         label = "Download primary data (expression value table of all tissues):",
                         choices = list("Human" = "Human", "Mouse" = "Mouse"),
                         selected = c("Human", "Mouse"),
                         inline = F
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "expressionDataButtonDownloadPrimaryTables",
                         label = "Download primary data"
                       ))
              )
            ) 
    ),
    # Slamseq  Data
    tabItem(tabName = "slamseqDataSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#slamseqDataInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput((outputId="slamseqDataInfo"))))),
            fluidRow(
              column(width = 9,
                     box(title = "Expression Levels", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="slamseqTotalDataTable"))),
                     box(title = "Expression Dyamics", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="slamseqDynamicsDataTable"))),
                     box(title = "Sample Meta Data", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="slamseqSampleMetaTable"))),
                     box(title = "DEA results", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="slamseqDeseq2Table"))),
                     box(title = "DEA Meta Data", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=FALSE, withSpinner(dataTableOutput(outputId="slamseqDeseq2MetaTable")))
              ),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         checkboxGroupInput(
                           "slamseqDataIncludeDataset",
                           label = "Include datasets:",
                           choices = list("Quant-seq" = "quant", "SLAM-seq" = "slam"),
                           selected = c("quant", "slam"),
                           inline = F
                         ),
                         radioButtons(
                           "slamseqDataSpeciesSelect",
                           label = "Species:",
                           choices = list(""),
                           selected = "",
                           inline = T
                         ),
                         radioButtons(
                           "slamseqDataUnitSelect",
                           label = "Expression metric:",
                           choices = list(""),
                           selected = "",
                           inline = T
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         checkboxInput(
                           inputId = "slamseqDataCheckOnlyIncludeBaseline",
                           label = "Only include baseline reference samples",
                           value = FALSE
                         ),
                         selectizeInput(
                           inputId = "slamseqDataTissueSelect",
                           label = "Tissue:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL),
                         disabled(
                           checkboxInput(
                             inputId = "slamseqDataCheckTissueAll",
                             label = "Search All Tissues",
                             value = FALSE)),
                         disabled(
                           selectizeInput(
                             inputId = "slamseqDataCellLineSelect",
                             label = "Cell Line:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL)),
                         disabled(
                           checkboxInput(
                             inputId = "slamseqDataCheckCellLineAll",
                             label = "Search All Cell Lines",
                             value = FALSE)),
                         disabled(
                           selectizeInput(
                             inputId = "slamseqDataGeneSelect",
                             label = "Gene:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL)),
                         disabled(
                           fileInput("slamseqData_inputFile", "Upload list of genes:",
                                     accept = c(
                                       "text/csv",
                                       "text/comma-separated-values,text/plain"))),
                         disabled(
                           checkboxInput(
                             inputId = "slamseqDataCheckGeneAll",
                             label = "Search All Genes",
                             value = FALSE)),
                         disabled(
                           actionButton(inputId = "slamseqDataLoadButton", 
                                        label = "Load data!"))
                         ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "slamseqExpressionDataButtonDownload",
                         label = "Download Expression Level table"
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "slamseqExpressionDynamicsDataButtonDownload",
                         label = "Download Expression Dynamics table"
                       ),
                       tags$br(),
                       downloadButton(
                         width = NULL,
                         outputId = "slamseqSampleMetaDataButtonDownload",
                         label = "Download Sample metadata table"
                       ),
                       tags$br(),
                       downloadButton(
                         width = NULL,
                         outputId = "slamseqDeseq2DataButtonDownload",
                         label = "Download DEA results table"
                       ),
                       tags$br(),
                       downloadButton(
                         width = NULL,
                         outputId = "slamseqDeseq2MetaDataButtonDownload",
                         label = "Download DEA metadata table"
                       )
                     )
              )
            ) 
    ),
    # Essentialome
    tabItem(tabName = "essentialomeSidebar", width = NULL, 
            fluidRow(
              column(width = 9, 
                     box(width = NULL, solidHeader = TRUE, withSpinner(dataTableOutput("essentialomeTableOutput")))
              ), 
              column(width = 3, 
                     box(width = NULL, solidHeader = TRUE, 
                         radioButtons(
                           "essentialomeSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human", "Mouse" = "mouse", "All"="all"),
                           selected = "human",
                           inline = T
                         ),
                         checkboxGroupInput(
                           "essentialomeDisplay",
                           label = "Display:",
                           choices = list("Essential genes" = "essential", "Nonessential genes" = "nonessential"),
                           selected = c("essential", "nonessential"),
                           inline = T
                         ),
                         selectInput(inputId = "essentialomeSelectSource",
                                     label = "Source:",
                                     choices = NULL,
                                     multiple = TRUE,
                                     selectize = TRUE),
                         checkboxInput(
                           inputId = "essentialomeCheckSourceAll",
                           label = "Display all essentialomes",
                           value = TRUE
                         )), 
                     infoBoxOutput(width = NULL, "essentialomeBoxEssentialGenesTotal"),
                     infoBoxOutput(width = NULL, "essentialomeBoxNonessentialGenesTotal"),
                     downloadButton(width = NULL, 
                                    outputId = "essentialomeButtonDownload",
                                    label = "Download")
              )
            )
    ),
    # correlations
    tabItem(tabName = "correlationsSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#correlationsInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput(outputId="correlationsInfo")))),
            fluidRow(
              column(width = 9, 
                     box(title = "Dependency <> Expression", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, withSpinner(dataTableOutput(outputId="correlationsDependencyExpressionTableOutput"))),
                     box(title = "Expression <> Dependency", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, withSpinner(dataTableOutput(outputId="correlationsExpressionDependencyTableOutput"))),
                     box(title = "Co-essentiality", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, withSpinner(dataTableOutput(outputId="correlationsCoEssentialityTableOutput"))),
                     box(title = "Co-expression", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, withSpinner(dataTableOutput(outputId="correlationsCoExpressionTableOutput")))
              ), 
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                       selectizeInput(
                         inputId = "correlationsTissueSelect",
                         label = "Tissue:",
                         choices = NULL,
                         multiple = FALSE,
                         selected = NULL
                       ),
                       selectizeInput(
                         inputId = "correlationsGeneSelect",
                         label = "Gene:",
                         choices = NULL,
                         multiple = TRUE,
                         selected = NULL
                       ),
                       fileInput(
                         "correlationsGeneInputFile", "Upload list of genes:",
                         accept = c("text/csv","text/comma-separated-values,text/plain")
                       ),
                       sliderInput(
                         "correlationsSliderCoeff", 
                         "Show top 20 correlations per gene or correlations with a pearson coeff above:",
                         min = 0.3,
                         max = 0.8,
                         value = 0.6
                       ),
                       sliderInput(
                         "correlationsSliderDatapoints", 
                         "Minimum amount of available datapoints for correlation:",
                         min = 10,
                         max = 500,
                         value = 150,
                         step = 1
                       ),
                       disabled(
                         actionButton(inputId = "correlationsLoadButton", 
                                      label = "Load data!"
                         )
                       )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       checkboxGroupInput(
                         "correlationsDownloadCheck",
                         label = "Download result tables:",
                         choices = list("Dependency <> Expression" = "Dependency <> Expression", "Expression <> Dependency" = "Expression <> Dependency", "Co-Essentiality" = "Co-Essentiality", "Co-Expression" = "Co-Expression"),
                         selected = c("Dependency <> Expression", "Expression <> Dependency", "Co-Expression", "Co-Essentiality"),
                         inline = F
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "correlationsButtonDownload",
                         label = "Download"
                       )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       checkboxGroupInput(
                         "correlationsDownloadPrimaryTablesCheck",
                         label = "Download primary data (top 20 correlation per gene or correlations with a pearson coeff > 0.6):",
                         choices = list("Dependency <> Expression" = "Dependency <> Expression","Expression <> Dependency" = "Expression <> Dependency", "Co-Essentiality" = "Co-Essentiality", "Co-Expression" = "Co-Expression"),
                         selected = c("Dependency <> Expression", "Expression <> Dependency", "Co-Expression", "Co-Essentiality"),
                         inline = F
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "correlationsButtonDownloadPrimaryTables",
                         label = "Download primary data"
                     ))
              )
          )
      ),
    # Patient mutation data 
    tabItem(tabName = "patientMutationSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#patientMutationInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput((outputId="patientMutationInfo"))))),
            fluidRow(
              column(width = 9,
                     box(title = "Gene alterations heatmap", status = "success", width=NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(imageOutput(outputId="patientMutationHeatmapAlterations", width="100%", height="20px"))),
                     box(title = "Gene alterations", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="patientMutationDataTableAlterations"))),
                     box(title = "Gene mutations ", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="patientMutationDataTableMutations"))),
                     box(title = "Gene fusions ", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="patientMutationDataTableFusions"))),
                     box(title = "Gene CNVs", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="patientMutationDataTableCNVs")))),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         radioButtons(
                           "patientMutationDataSourceSelect",
                           label = "Data sources:",
                           choices = list("All" = "all", "Pediatric studies" = "pediatric", "Non-pediatric studies" = "non_pediatric"),
                           selected = c("all"),
                           inline = T
                         ),
                         radioButtons(
                           "patientMutationDataTypeSelect",
                           label = "Focus on:",
                           choices = list("Alterations (any gene modification)" = "alterations", 
                                          "Deletions" = "deletions", 
                                          "Amplifications" = "amplifications", 
                                          "Mutations"="mutations", 
                                          "Fusions"="fusions"),
                           selected = c("alterations"),
                           inline = F
                         ),
                         radioButtons(
                           "patientMutationDataGrouping",
                           label = "Grouping by:",
                           choices = list("Cancer type" = "cancer_type", "Study" = "study_name"),
                           selected = c("cancer_type"),
                           inline = T
                         ),
                         selectizeInput(
                           inputId = "patientMutationGroupSelect",
                           label = "Group:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "patientMutationCheckGroupAll",
                           label = "Search all groups",
                           value = FALSE
                         ),
                         selectizeInput(
                           inputId = "patientMutationGeneSelect",
                           label = "Gene:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         fileInput("patientMutationGeneInputFile", "Upload list of genes:",
                                            accept = c(
                                              "text/csv",
                                              "text/comma-separated-values,text/plain")
                         ),
                         checkboxInput(
                           inputId = "patientMutationCheckAgeFiltering",
                           label = "Filter patients by Age",
                           value = FALSE
                         ),
                         disabled(
                           sliderInput(
                           "patientMutationAgeFiltering", 
                           "Age of patients:",
                           min = 0,
                           max = 100,
                           value = c(0, 18)
                          )
                         ),
                         sliderInput(
                           "patientMutationMinPatients", 
                           "Minimum amount of patients in group:",
                           min = 10,
                           max = 500,
                           value = 25
                         ),
                         sliderInput(
                           "patientMutationMaxHeatmapColour", 
                           "Group percentage threshold for maximum color:",
                           min = 2,
                           max = 50,
                           value = 5
                         ),
                         disabled(
                           actionButton(inputId = "patientMutationLoadButton", 
                                        label = "Load data!"
                           )
                         )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       checkboxGroupInput(
                         "patientMutationDownloadCheck",
                         label = "Download result tables:",
                         choices = list("Gene alterations heatmap" = "Gene alterations heatmap", 
                                        "Gene alterations" = "Gene alterations", 
                                        "Gene mutations" = "Gene mutations", 
                                        "Gene fusions" = "Gene fusions", 
                                        "Gene CNVs" = "Gene CNVs"),
                         selected = c("Gene alterations heatmap", "Gene alterations", "Gene mutations", "Gene fusions", "Gene CNVs"),
                         inline = F
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "patientMutationButtonDownload",
                         label = "Download"
                       )
                     )
              )
            ) 
    ),
    # Cell line meta data 
    tabItem(tabName = "cellLineSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#cellLineInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput((outputId="cellLineInfo"))))),
            fluidRow(
              column(width = 9,
                     box(title = "Cellline meta data", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineDataTableMeta"))),
                     box(title = "Gene mutations ", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineDataTableMutations"))),
                     box(title = "Gene fusions ", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineDataTableFusions"))),
                     box(title = "Gene CNVs", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineDataTableCNVs")))),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         selectizeInput(
                           inputId = "cellLineTissueSelect",
                           label = "Tissue:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "cellLineCheckTissueAll",
                           label = "Search All Tissues",
                           value = FALSE
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "cellLineCellLineSelect",
                             label = "Cell Line:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           checkboxInput(
                             inputId = "cellLineCheckCellLineAll",
                             label = "Search All Cell Lines",
                             value = FALSE
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "cellLineGeneSelect",
                             label = "Gene:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(fileInput("cellLine_inputFile", "Upload list of genes:",
                                            accept = c(
                                              "text/csv",
                                              "text/comma-separated-values,text/plain")
                         )),
                         disabled(
                           checkboxInput(
                             inputId = "cellLineCheckGeneAll",
                             label = "Search All Genes",
                             value = FALSE
                           )
                         ),
                         disabled(
                           actionButton(inputId = "cellLineLoadButton", 
                                        label = "Load data!"
                           )
                         )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       checkboxGroupInput(
                         "cellLineDownloadCheck",
                         label = "Download result tables:",
                         choices = list("Cellline meta data" = "Cellline meta data", "Gene mutations" = "Gene mutations", "Gene fusions" = "Gene fusions", "Gene CNVs" = "Gene CNVs"),
                         selected = c("Cellline meta data", "Gene mutations", "Gene fusions", "Gene CNVs"),
                         inline = F
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "cellLineButtonDownload",
                         label = "Download"
                       )
                     )
              )
            ) 
    ),
    # Cell line selector
    tabItem(tabName = "cellLineSelectorSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#cellLineSelectorInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput((outputId="cellLineSelectorInfo"))))),
            fluidRow(
              column(width = 9,
                     box(title = "Cellline meta data", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineSelectorDataTableMeta"))),
                     box(title = "Screen results", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineSelectorDataTableScreens"))),
                     box(title = "Expression levels", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineSelectorDataTableExpression"))),
                     box(title = "Gene mutations ", status = "success", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineSelectorDataTableMutations"))),
                     box(title = "Gene fusions ", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineSelectorDataTableFusions"))),
                     box(title = "Gene CNVs", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineSelectorDataTableCNVs"))),
                     box(title = "HLA types", status = "danger", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="cellLineSelectorDataTableHLAs")))),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         selectizeInput(
                           inputId = "cellLineSelectorTissueSelect",
                           label = "Tissue:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "cellLineSelectorCheckTissueAll",
                           label = "Search All Tissues",
                           value = FALSE
                         )
                      ),
                      box(width = NULL, solidHeader = TRUE,
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorGeneMutationSelect",
                             label = "Gene mutation:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorGeneMutationProteinSelect",
                             label = "Protein mutation:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         )
                      ),
                      box(width = NULL, solidHeader = TRUE,
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorGeneDependencySelect",
                             label = "Gene dependency:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         sliderInput(
                           "cellLineSelectorGeneDependencySlider", 
                           "Filter for cell lines with scaled gene dependency (-1 equals to mean essential gene dropout):",
                           min = -1,
                           max = 0,
                           value = -0.5
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorGeneExpressionSelect",
                             label = "Gene expression:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         sliderInput(
                           "cellLineSelectorGeneExpressionSlider", 
                           "Filter for cell lines with gene expression (log2-TPMs):",
                           min = 0,
                           max = 15,
                           value = 1
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorHLAtypeSelect",
                             label = "HLA-type:",
                             choices = c("-"="none", "HLA-A"="HLA-A","HLA-B"="HLA-B","HLA-C"="HLA-C","HLA-DQA1"="HLA-DQA1","HLA-DQB1"="HLA-DQB1","HLA-DRB1"="HLA-DRB1"),
                             multiple = FALSE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorHLAalleleSelect",
                             label = "HLA-allele:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         sliderInput(
                           "cellLineSelectorHLAExpressionSlider", 
                           "Filter for cell lines with HLA-type expression (RPKMs):",
                           min = 0,
                           max = 1000,
                           value = 5
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorGeneFusion3primeSelect",
                             label = "3' gene fusion :",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorGeneFusion5primeSelect",
                             label = "5' gene fusion :",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorGeneCNVSelect",
                             label = "Gene CNV:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         ),
                         disabled(
                           selectizeInput(
                             inputId = "cellLineSelectorGeneCNVCategorySelect",
                             label = "Gene CNV category:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           )
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         disabled(
                           actionButton(inputId = "cellLineSelectorLoadButton", 
                                        label = "Load data!"
                           )
                         )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       checkboxGroupInput(
                         "cellLineSelectorDownloadCheck",
                         label = "Download result tables:",
                         choices = list("Cellline meta data" = "Cellline meta data", "Screen results" = "Screen results", "Gene mutations" = "Gene mutations", "Gene fusions" = "Gene fusions", "Gene CNVs" = "Gene CNVs", "HLA types" = "HLA types"),
                         selected = c("Cellline meta data", "Screen results", "Gene mutations", "Gene fusions", "Gene CNVs", "HLA types" = "HLA types"),
                         inline = F
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "cellLineSelectorButtonDownload",
                         label = "Download"
                       )
                     )
              )
            ) 
    ),
    #Group Testing  
    tabItem(tabName = "groupTestingSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#groupTestingInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput((outputId="groupTestingInfo"))))),
            fluidRow(
              column(width = 9,
                     box(title = "Group testing plot", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(plotlyOutput(outputId="groupTestingPlot", height = "auto"))),
                     box(title = "Group testing results", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="groupTestingDataTableResults"))),
                     box(title = "Group testing contrasts", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput(outputId="groupTestingDataTableContrasts")))
                     ),
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         
                         radioButtons(
                           "groupTestingSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human"),
                           selected = "human",
                           inline = T
                         ),
                         radioButtons(
                           "groupTestingDatasetSelect",
                           label = "Dataset:",
                           choices = list("Gene dependency (dropout screens)" = "dependency", "Gene expression" = "expression"),
                           selected = "dependency",
                           inline = F
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         radioButtons(
                           "groupTestingSearchRadio",
                           label = "Compare:",
                           choices = list("Guide-level" = "guide", "Gene-level" = "gene"),
                           selected = "gene",
                           inline = T
                         ),
                         selectizeInput(
                           inputId = "groupTestingLibrarySelect",
                           label = "sgRNA library:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "groupTestingCheckLibraryAll",
                           label = " Consider all libraries",
                           value = TRUE
                         )
                     ),
                     box(title = "Target group", width = NULL, solidHeader = TRUE,
                         selectizeInput(
                           inputId = "groupTestingFilteringGroupSelect",
                           label = "Tissue/Cancer type filtering groups:",
                           choices = c("Tissue"="tissue_name", "Cancer Type (Cell-Model-Passports)"="SangerCellModelPassports_cancer_type", 
                                      "Cancer Type Detail (Cell-Model-Passports)"="SangerCellModelPassports_cancer_type_detail", 
                                      "Oncotree Subtype (DepMap)"="BroadDepMap_OncotreeSubtype", "Oncrotree Primary Disease (DepMap)"="BroadDepMap_OncotreePrimaryDisease"),
                           multiple = TRUE,
                           selected = c("tissue_name")
                         ),
                         selectizeInput(
                           inputId = "groupTestingFilteringValueSelect",
                           label = "Tissue/Cancer type filtering values:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "groupTestingCheckTissueAll",
                           label = "Consider all tissues/cancer types",
                           value = TRUE
                         ),
                         selectizeInput(
                           inputId = "groupTestingGeneDependencySelect",
                           label = "Gene dependency:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         sliderInput(
                           "groupTestingGeneDependencySlider", 
                           "Filter for cell lines with scaled gene dependency stronger or euqal than (-1 equals to mean essential gene dropout):",
                           min = -1,
                           max = 0,
                           value = c(-0.66)
                         ),
                         selectizeInput(
                           inputId = "groupTestingGeneExpressionSelect",
                           label = "Gene expression:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         sliderInput(
                           "groupTestingGeneExpressionSlider", 
                           "Filter for cell lines with gene expression higher or equal than (log2-TPMs):",
                           min = 0,
                           max = 15,
                           value = c(5)
                         ),
                         selectizeInput(
                           inputId = "groupTestingCellLineSelect",
                           label = "Cell Line:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ),
                         checkboxInput(
                           inputId = "groupTestingCheckCellLineAll",
                           label = "Consider all cell lines",
                           value = FALSE
                         ),
                     ),
                     disabled(
                       box(id="groupTestingRest", title = "Control group", width = NULL, solidHeader = TRUE,
                           
                           selectizeInput(
                             inputId = "groupTestingRestFilteringGroupSelect",
                             label = "Other tissue/cancer type filtering groups:",
                             choices = c("Tissue"="tissue_name", "Cancer Type (Cell-Model-Passports)"="SangerCellModelPassports_cancer_type", 
                                         "Cancer Type Detail (Cell-Model-Passports)"="SangerCellModelPassports_cancer_type_detail", 
                                         "Oncotree Subtype (DepMap)"="BroadDepMap_OncotreeSubtype", "Oncrotree Primary Disease (DepMap)"="BroadDepMap_OncotreePrimaryDisease"),
                             multiple = TRUE,
                             selected = c("tissue_name")
                           ),
                           selectizeInput(
                             inputId = "groupTestingRestFilteringValueSelect",
                             label = "Other tissue/cancer type filtering values:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           ),
                           checkboxInput(
                             inputId = "groupTestingRestCheckTissueAll",
                             label = "Consider all other tissues/cancer types",
                             value = FALSE
                           ),
                           selectizeInput(
                             inputId = "groupTestingRestGeneDependencySelect",
                             label = "Gene dependency:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           ),
                           sliderInput(
                             "groupTestingRestGeneDependencySlider", 
                             "Filter for cell lines with scaled gene dependency weaker or euqal than (-1 equals to mean essential gene dropout):",
                             min = -1,
                             max = 0,
                             value = c(-0.33)
                           ),
                           selectizeInput(
                             inputId = "groupTestingRestGeneExpressionSelect",
                             label = "Gene expression:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           ),
                           sliderInput(
                             "groupTestingRestGeneExpressionSlider", 
                             "Filter for cell lines with gene expression lower or equal than (log2-TPMs):",
                             min = 0,
                             max = 15,
                             value = c(0)
                           ),
                           selectizeInput(
                             inputId = "groupTestingRestCellLineSelect",
                             label = "Other Cell Line:",
                             choices = NULL,
                             multiple = TRUE,
                             selected = NULL
                           ),
                           checkboxInput(
                             inputId = "groupTestingRestCheckCellLineAll",
                             label = "Consider all other cell lines",
                             value = FALSE
                           )
                       )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                       disabled(
                         actionButton(inputId = "groupTestingLoadButton", 
                                      label = "Load data!"
                         )
                       )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "groupTestingButtonDownload",
                         label = "Download"
                       )
                     )
              )
            ) 
    ),
    # Gene of interest
    tabItem(tabName = "geneOfInterestSidebar", width = NULL, 
            fluidRow(tags$head(tags$style(HTML('#geneOfInterestInfo{color:tomato; font-weight: bold;}'))),
                     column(width = 12,
                            box(width = NULL, solidHeader = TRUE, htmlOutput(outputId="geneOfInterestInfo")))),
            fluidRow(
              column(width = 9, 
                     box(title = "CRISPR/Cas9 screen hits", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput("geneOfInterestScreenHitsTable"))),
                     box(title = "Differental expression analysis hits", status = "info", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput("geneOfInterestDEAHitsTable"))),
                     box(title = "CRISPR/Cas9 screen meta data", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput("geneOfInterestScreenMetaTable"))),
                     box(title = "Differental expression analysis meta data", status = "warning", width = NULL, solidHeader = TRUE, collapsible = TRUE, collapsed=F, withSpinner(dataTableOutput("geneOfInterestDEAMetaTable")))
              ), 
              column(width = 3,
                     box(width = NULL, solidHeader = TRUE,
                         
                         radioButtons(
                           "geneOfInterestSpeciesSelect",
                           label = "Species:",
                           choices = list("Human" = "human", "Mouse" = "mouse"),
                           selected = "",
                           inline = T
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         radioButtons(
                           "geneOfInterestSearchRadio",
                           label = "Screens filtering level:",
                           choices = list("Genes" = "gene_stats", "Guides" = "guide_stats"),
                           selected = "gene_stats",
                           inline = T
                         ),
                         checkboxGroupInput(
                           "geneOfInterestScreenInclude",
                           label = "Include screen gene hits:",
                           choices = list("Depleting" = "depletion", "Enriching" = "enrichment"),
                           selected = c("depletion", "enrichment"),
                           inline = T
                         ),
                         sliderInput("geneOfInterestScreenDepletingLFC", "Minimal depleting LFC in CRISPR/Cas9 screen:",
                           min = -8, 
                           max = 0, 
                           value = -2,
                           step = 0.1
                         ),
                         sliderInput("geneOfInterestScreenEnrichingLFC", "Minimal enriching LFC in CRISPR/Cas9 screen:",
                           min = 0, 
                           max = 6, 
                           value = 2,
                           step = 0.1
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         checkboxGroupInput(
                           "geneOfInterestDEAInclude",
                           label = "Include DEA gene hits:",
                           choices = list("Depleting" = "depletion", "Enriching" = "enrichment"),
                           selected = c("depletion", "enrichment"),
                           inline = T
                         ),
                         sliderInput("geneOfInterestDEADepletingLFC", "Minimal depleting LFC in differential expression analysis:",
                                     min = -3, 
                                     max = 0, 
                                     value = -1,
                                     step = 0.1
                         ),
                         sliderInput("geneOfInterestDEAEnrichingLFC", "Minimal enriching LFC in differential expression analysis:",
                                     min = 0, 
                                     max = 3, 
                                     value = 1,
                                     step = 0.1
                         )
                     ),
                     box(width = NULL, solidHeader = TRUE,
                         
                         selectizeInput(
                           inputId = "geneOfInterestGeneSelect",
                           label = "Gene:",
                           choices = NULL,
                           multiple = TRUE,
                           selected = NULL
                         ), 
                         fileInput(
                           "geneOfInterestGeneInputFile", "Upload list of genes:",
                           accept = c("text/csv","text/comma-separated-values,text/plain")
                         ),
                         disabled(
                           actionButton(inputId = "geneOfInterestLoadButton", 
                                        label = "Load data!"
                           )
                         )
                     ),
                     box(
                       width = NULL,
                       solidHeader = TRUE,
                       downloadButton(
                         width = NULL,
                         outputId = "geneOfInterestScreenHitsButtonDownload",
                         label = "Download screen hits table"
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "geneOfInterestDEAHitsButtonDownload",
                         label = "Download DEA hits table"
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "geneOfInterestScreenMetaButtonDownload",
                         label = "Download screen metadata table"
                       ),
                       downloadButton(
                         width = NULL,
                         outputId = "geneOfInterestDEAMetaButtonDownload",
                         label = "Download DEA metadata table"
                       )
                     )
              )
            )
          )
    
  )
)
  
ui <- tagList(
  tags$head(
    tags$style(HTML("
    html {
      /* This affects elements that use rem/em units */
      font-size: 80% !important;
    }
    
    /* Scale down sidebar menu items */
    .sidebar-menu li a {
      font-size: 0.8em !important;
    }
    /* Scale down boxes */
    .box-body {
      font-size: 0.8em !important;
    }
    
    .box-title {
      font-size: 1em !important;
    }
    
    .item {
      font-size: 0.8em !important;
    }
    .shiny-input-checkbox {
      transform: scale(0.8);
    }
    .form-control {
      padding: 0.4em 0.8em !important;
      height: auto !important;
    }
    
    /* (Add similar overrides for other elements as needed.) */
  "))
  ),
  tags$script(HTML("
      Shiny.addCustomMessageHandler('updateImageHeight', function(message) {
        $('#patientMutationHeatmapAlterations').css('height', message.height + 'px');
      });
    ")),
  dashboardPage(
    header,
    sidebar,
    body
  )
)